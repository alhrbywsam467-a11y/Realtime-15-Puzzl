<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ù„ØºØ§Ø² Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <style>
        body { background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .room-box { background: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #38bdf8; text-align: center; width: 90%; max-width: 400px; }
        #status { color: #4ade80; margin-bottom: 10px; font-weight: bold; }
        .board { display: grid; grid-template-columns: repeat(4, 70px); gap: 10px; background: #1e293b; padding: 15px; border-radius: 15px; }
        .tile { width: 70px; height: 70px; background: #38bdf8; color: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; border-radius: 10px; cursor: pointer; }
        .tile.empty { background: #334155; }
        .copy-btn { background: #38bdf8; color: #0f172a; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<div class="room-box">
    <div id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
    <p style="font-size: 0.8rem;">Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ø®ÙˆÙŠÙƒ:</p>
    <input type="text" id="linkText" style="width: 100%; background: #0f172a; color: white; border: 1px solid #334155; padding: 5px;" readonly>
    <button class="copy-btn" onclick="copyMyLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ğŸ”—</button>
</div>

<div class="board" id="board"></div>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø·
    const params = new URLSearchParams(window.location.search);
    let roomId = params.get('r') || Math.random().toString(36).substring(7);
    if (!params.has('r')) {
        window.history.replaceState({}, '', '?r=' + roomId);
    }
    document.getElementById('linkText').value = window.location.href;

    // 2. Ø±Ø¨Ø· Ø³ÙŠØ±ÙØ± Pusher (Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ©)
    const pusher = new Pusher('d97e993537a30a3c6a81', { cluster: 'ap2', forceTLS: true });
    
    // ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù‚Ù†Ø§Ø© ÙŠØ¨Ø¯Ø£ Ø¨Ù€ client- Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
    const channel = pusher.subscribe('private-room-' + roomId);

    let tiles = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];

    pusher.connection.bind('connected', () => {
        document.getElementById('status').innerText = "Ù…ØªØµÙ„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† âœ… (Ø§Ù„ØºØ±ÙØ©: " + roomId + ")";
    });

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
    channel.bind('client-move', (data) => {
        tiles = data.newTiles;
        render();
    });

    function render() {
        const b = document.getElementById('board'); b.innerHTML = '';
        tiles.forEach((n, i) => {
            const d = document.createElement('div');
            d.className = `tile ${n===0?'empty':''}`; d.innerText = n||'';
            if(n!==0) d.onclick = () => {
                const z = tiles.indexOf(0);
                if ([i-1, i+1, i-4, i+4].includes(z)) {
                    [tiles[i], tiles[z]] = [tiles[z], tiles[i]];
                    render();
                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ© ÙÙˆØ±Ø§Ù‹
                    channel.trigger('client-move', { newTiles: tiles });
                }
            };
            b.appendChild(d);
        });
    }

    function copyMyLink() {
        const t = document.getElementById("linkText");
        t.select(); document.execCommand("copy");
        alert("ØªÙ… Ø§Ù„Ù†Ø³Ø®! Ø£Ø±Ø³Ù„Ù‡ Ù„Ø®ÙˆÙŠÙƒ Ø§Ù„Ø¢Ù†.");
    }

    render();
</script>
</body>
</html>
