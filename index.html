<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØºØ±ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø®Ø§ØµØ©</title>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <style>
        body { background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .room-info { background: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #38bdf8; text-align: center; width: 320px; }
        .copy-btn { background: #38bdf8; color: #0f172a; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; width: 100%; }
        .copy-btn:active { background: #4ade80; }
        .board { display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; background: #1e293b; padding: 20px; border-radius: 15px; }
        .tile { width: 80px; height: 80px; background: #38bdf8; color: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .tile.empty { background: #334155; }
    </style>
</head>
<body>

    <div class="room-info">
        <div id="status" style="color: #4ade80; margin-bottom: 10px;">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©...</div>
        <input type="text" id="gameLink" style="width: 100%; padding: 5px; background: #0f172a; color: white; border: 1px solid #334155; text-align: center;" readonly>
        <button class="copy-btn" onclick="copyLink()">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© ğŸ”—</button>
    </div>

    <div class="board" id="board"></div>

    <script>
        // 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©
        const params = new URLSearchParams(window.location.search);
        let roomId = params.get('room') || Math.random().toString(36).substring(7);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        if (!params.has('room')) {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?room=' + roomId;
            window.history.replaceState({path: newUrl}, '', newUrl);
        }
        document.getElementById('gameLink').value = window.location.href;

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ± (Pusher)
        const pusher = new Pusher('d97e993537a30a3c6a81', { 
            cluster: 'ap2',
            forceTLS: true // ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„
        });

        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© "Ø®Ø§ØµØ©" Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… (Ø§Ù„Ø±ÙˆÙ…) ÙÙ‚Ø·
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§Ø³Ù… Ø¨Ù€ client- Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        const channel = pusher.subscribe('client-room-' + roomId);

        pusher.connection.bind('connected', () => {
            document.getElementById('status').innerText = "Ø£Ù†Øª ÙÙŠ Ø§Ù„ØºØ±ÙØ©: " + roomId;
        });

        let tiles = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª
        channel.bind('client-move', (data) => {
            tiles = data.newTiles;
            render();
        });

        function render() {
            const b = document.getElementById('board'); b.innerHTML = '';
            tiles.forEach((n, i) => {
                const d = document.createElement('div');
                d.className = `tile ${n===0?'empty':''}`; d.innerText = n||'';
                if(n!==0) d.onclick = () => {
                    const z = tiles.indexOf(0);
                    if ([i-1, i+1, i-4, i+4].includes(z)) {
                        [tiles[i], tiles[z]] = [tiles[z], tiles[i]];
                        render();
                        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ© ÙÙˆØ±Ø§Ù‹ Ù„Ø®ÙˆÙŠÙƒ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØºØ±ÙØ©
                        channel.trigger('client-move', { newTiles: tiles });
                    }
                };
                b.appendChild(d);
            });
        }

        function copyLink() {
            const copyText = document.getElementById("gameLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„Ø®ÙˆÙŠÙƒ.");
        }

        render();
    </script>
</body>
</html>
