<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحدي الذكاء أونلاين - سحابة Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --sky: #87CEEB; --bg: #f5f9fc; }
        body { background: var(--bg); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        .status-bar { background: white; padding: 10px 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; color: #555; font-weight: bold; }
        
        .board { display: grid; grid-template-columns: repeat(4, 75px); gap: 10px; background: #e2eef5; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .tile { width: 75px; height: 75px; background: var(--sky); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.1s; box-shadow: 0 4px 0 #76b7d1; user-select: none; }
        .tile:active { transform: translateY(3px); box-shadow: none; }
        .tile.empty { background: transparent; box-shadow: none; cursor: default; }

        .btn { margin-top: 25px; background: var(--sky); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: #00BFFF; }
    </style>
</head>
<body>

    <div class="status-bar" id="status">جاري الاتصال بالخادم...</div>

    <div class="board" id="board"></div>

    <button class="btn" onclick="shuffleGlobal()">إعادة خلط للجميع</button>

    <script>
        // --- بيانات الخادم الخاص بك ---
        const SUPABASE_URL = 'https://eustyapglsrnmqivwimo.supabase.co'; 
        
        // !!! هام: الصق هنا المفتاح الطويل (anon key) الذي نسخته من الصورة !!!
        const SUPABASE_KEY = 'sb_publishable_eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnYmpkbXJ5YXZ1eXFkanV2aWVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MDY5NjYsImV4cCI6MjA1MTE4Mjk2Nn0.8Xk3V-6K_W6y_4-2N_G-6u7_9V-6u7_9V-6u7_9V-6u7_9';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let tiles = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];
        const boardEl = document.getElementById('board');

        // الربط المباشر (Realtime)
        const channel = supabaseClient.channel('game_room')
            .on('broadcast', { event: 'move' }, ({ payload }) => {
                tiles = payload.newTiles;
                render();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    document.getElementById('status').innerText = "متصل أونلاين ✅";
                    render();
                }
            });

        function render() {
            boardEl.innerHTML = '';
            tiles.forEach((num, idx) => {
                const div = document.createElement('div');
                div.className = `tile ${num === 0 ? 'empty' : ''}`;
                div.innerText = num || '';
                if (num !== 0) div.onclick = () => handleMove(idx);
                boardEl.appendChild(div);
            });
        }

        function handleMove(idx) {
            const emptyIdx = tiles.indexOf(0);
            if (isAdjacent(idx, emptyIdx)) {
                [tiles[idx], tiles[emptyIdx]] = [tiles[emptyIdx], tiles[idx]];
                render();
                // إرسال الحركة فوراً للخادم
                channel.send({
                    type: 'broadcast',
                    event: 'move',
                    payload: { newTiles: tiles }
                });
            }
        }

        function isAdjacent(i, j) {
            const r1 = Math.floor(i/4), c1 = i%4;
            const r2 = Math.floor(j/4), c2 = j%4;
            return Math.abs(r1-r2) + Math.abs(c1-c2) === 1;
        }

        function shuffleGlobal() {
            tiles.sort(() => Math.random() - 0.5);
            render();
            channel.send({ type: 'broadcast', event: 'move', payload: { newTiles: tiles } });
        }
    </script>
</body>
</html>