<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تحدي الأرقام - رابط خاص</title>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <style>
        body { background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: sans-serif; }
        .share-box { background: #1e293b; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #38bdf8; text-align: center; }
        input { background: #0f172a; color: #4ade80; border: 1px solid #334155; padding: 5px; width: 250px; border-radius: 5px; }
        .board { display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; background: #1e293b; padding: 20px; border-radius: 15px; }
        .tile { width: 80px; height: 80px; background: #38bdf8; color: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; border-radius: 10px; cursor: pointer; }
        .tile.empty { background: #334155; }
    </style>
</head>
<body>
    <div class="share-box">
        <p>أرسل هذا الرابط لخويك ليلعب معك:</p>
        <input type="text" id="gameLink" readonly>
    </div>
    <div class="board" id="board"></div>

    <script>
        // 1. توليد أو قراءة معرف الغرفة من الرابط
        const urlParams = new URLSearchParams(window.location.search);
        let roomId = urlParams.get('room');
        if (!roomId) {
            roomId = Math.random().toString(36).substring(7);
            window.history.replaceState({}, '', '?room=' + roomId);
        }
        document.getElementById('gameLink').value = window.location.href;

        // 2. إعداد Pusher
        const pusher = new Pusher('d97e993537a30a3c6a81', { 
            cluster: 'ap2',
            forceTLS: true // الخيار الذي سألت عنه لتأمين الاتصال
        });

        // الاشتراك في قناة خاصة بهذا الرابط فقط
        const channel = pusher.subscribe('client-room-' + roomId);

        let tiles = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0];

        // استقبال الحركة
        channel.bind('client-move', (data) => {
            tiles = data.newTiles;
            render();
        });

        function render() {
            const b = document.getElementById('board'); b.innerHTML = '';
            tiles.forEach((n, i) => {
                const d = document.createElement('div');
                d.className = `tile ${n===0?'empty':''}`; d.innerText = n||'';
                if(n!==0) d.onclick = () => {
                    const z = tiles.indexOf(0);
                    if ([i-1, i+1, i-4, i+4].includes(z)) {
                        [tiles[i], tiles[z]] = [tiles[z], tiles[i]];
                        render();
                        // إرسال الحركة للغرفة الخاصة
                        channel.trigger('client-move', { newTiles: tiles });
                    }
                };
                b.appendChild(d);
            });
        }
        render();
    </script>
</body>
</html>
